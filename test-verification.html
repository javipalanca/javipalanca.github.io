<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SPADE Demo Verification</title>
    <script src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 20px;
        background: #f5f5f5;
      }

      .test-container {
        background: white;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }

      .success {
        color: #27ae60;
      }
      .error {
        color: #e74c3c;
      }
      .warning {
        color: #f39c12;
      }
      .info {
        color: #3498db;
      }

      .test-result {
        padding: 5px 0;
        font-family: monospace;
      }

      button {
        padding: 8px 16px;
        margin: 5px;
        border: none;
        border-radius: 4px;
        background: #3498db;
        color: white;
        cursor: pointer;
      }

      button:hover {
        background: #2980b9;
      }

      #test-output {
        background: #2c3e50;
        color: #ecf0f1;
        padding: 15px;
        border-radius: 4px;
        font-family: monospace;
        font-size: 12px;
        max-height: 400px;
        overflow-y: auto;
        white-space: pre-wrap;
      }

      .demo-mini {
        width: 100%;
        height: 300px;
        border: 1px solid #ddd;
        border-radius: 4px;
        margin: 10px 0;
      }
    </style>
  </head>
  <body>
    <div class="test-container">
      <h1>🧪 SPADE Demo Enhancement Verification</h1>
      <p>
        This page tests the enhanced multi-message broadcasting and event-driven
        behavior capabilities.
      </p>

      <div>
        <button onclick="runAllTests()">🚀 Run All Tests</button>
        <button onclick="testBroadcastFeatures()">
          📡 Test Broadcast Features
        </button>
        <button onclick="testEventDrivenBehaviors()">
          ⚡ Test Event-Driven Behaviors
        </button>
        <button onclick="testDemoScenarios()">🎭 Test Demo Scenarios</button>
        <button onclick="clearOutput()">🧹 Clear Output</button>
      </div>
    </div>

    <div class="test-container">
      <h2>📊 Test Results</h2>
      <div id="test-output">
        Click "Run All Tests" to begin verification...\n
      </div>
    </div>

    <div class="test-container">
      <h2>🎮 Live Demo Test</h2>
      <p>Mini version of the demo for testing:</p>
      <div id="mini-demo" class="demo-mini"></div>
      <div>
        <select id="mini-scenario">
          <option value="simple">Basic Communication</option>
          <option value="event_driven">Event-Driven Behaviors</option>
          <option value="presence">Presence Notification</option>
          <option value="pubsub">Publish-Subscribe</option>
        </select>
        <button onclick="startMiniDemo()">▶️ Start</button>
        <button onclick="pauseMiniDemo()">⏸️ Pause</button>
        <button onclick="resetMiniDemo()">🔄 Reset</button>
      </div>
    </div>

    <script src="/js/demos.js"></script>
    <script>
      let output = "";
      let testCount = 0;
      let passCount = 0;
      let failCount = 0;

      function log(message, type = "info") {
        const timestamp = new Date().toLocaleTimeString();
        const prefix =
          {
            success: "✅",
            error: "❌",
            warning: "⚠️",
            info: "ℹ️",
          }[type] || "ℹ️";

        output += `[${timestamp}] ${prefix} ${message}\n`;
        document.getElementById("test-output").textContent = output;
        document.getElementById("test-output").scrollTop =
          document.getElementById("test-output").scrollHeight;
      }

      function test(description, testFunc) {
        testCount++;
        log(`Testing: ${description}`, "info");
        try {
          const result = testFunc();
          if (result === true || result === undefined) {
            passCount++;
            log(`PASS: ${description}`, "success");
            return true;
          } else {
            failCount++;
            log(`FAIL: ${description} - ${result}`, "error");
            return false;
          }
        } catch (error) {
          failCount++;
          log(`ERROR: ${description} - ${error.message}`, "error");
          return false;
        }
      }

      function clearOutput() {
        output = "";
        testCount = 0;
        passCount = 0;
        failCount = 0;
        document.getElementById("test-output").textContent =
          "Output cleared.\n";
      }

      async function runAllTests() {
        clearOutput();
        log("🔍 Starting comprehensive SPADE demo verification...", "info");

        // Test basic functionality
        testBasicFunctionality();

        // Test enhanced features
        testBroadcastFeatures();
        testEventDrivenBehaviors();

        // Test demo scenarios
        await testDemoScenarios();

        // Summary
        log(`\n📋 Test Summary:`, "info");
        log(`Total Tests: ${testCount}`, "info");
        log(`Passed: ${passCount}`, "success");
        log(`Failed: ${failCount}`, failCount > 0 ? "error" : "success");
        log(
          `Success Rate: ${((passCount / testCount) * 100).toFixed(1)}%`,
          passCount === testCount ? "success" : "warning"
        );

        if (passCount === testCount) {
          log(
            "🎉 All tests passed! Enhanced demo is working correctly.",
            "success"
          );
        } else {
          log("⚠️ Some tests failed. Check the details above.", "warning");
        }
      }

      function testBasicFunctionality() {
        log("\n🔧 Testing Basic Functionality...", "info");

        test("AgentDemo object exists", () => {
          return typeof AgentDemo !== "undefined";
        });

        test("AgentDemo has init method", () => {
          return typeof AgentDemo.init === "function";
        });

        test("vis.js library is loaded", () => {
          return typeof vis !== "undefined";
        });
      }

      function testBroadcastFeatures() {
        log("\n📡 Testing Broadcast Features...", "info");

        test("sendMessage method exists", () => {
          return typeof AgentDemo.sendMessage === "function";
        });

        test("sendBroadcastMessage method exists", () => {
          return typeof AgentDemo.sendBroadcastMessage === "function";
        });

        test("sendSingleMessage method exists", () => {
          return typeof AgentDemo.sendSingleMessage === "function";
        });

        test("getConnectedNodes method exists", () => {
          return typeof AgentDemo.getConnectedNodes === "function";
        });

        test("broadcastPresence method exists", () => {
          return typeof AgentDemo.broadcastPresence === "function";
        });

        test("publishToSubscribers method exists", () => {
          return typeof AgentDemo.publishToSubscribers === "function";
        });

        test("getPresenceColor method exists", () => {
          return typeof AgentDemo.getPresenceColor === "function";
        });

        test("getTopicColor method exists", () => {
          return typeof AgentDemo.getTopicColor === "function";
        });
      }

      function testEventDrivenBehaviors() {
        log("\n⚡ Testing Event-Driven Behaviors...", "info");

        test("handleMessageArrival method exists", () => {
          return typeof AgentDemo.handleMessageArrival === "function";
        });

        test("processBehaviorOnMessageArrival method exists", () => {
          return (
            typeof AgentDemo.processBehaviorOnMessageArrival === "function"
          );
        });

        test("handleScenarioSpecificArrival method exists", () => {
          return typeof AgentDemo.handleScenarioSpecificArrival === "function";
        });

        test("getAvailableWorkers method exists", () => {
          return typeof AgentDemo.getAvailableWorkers === "function";
        });

        test("setWorkerState method exists", () => {
          return typeof AgentDemo.setWorkerState === "function";
        });

        test("createArrivalEffect method exists", () => {
          return typeof AgentDemo.createArrivalEffect === "function";
        });
      }

      async function testDemoScenarios() {
        log("\n🎭 Testing Demo Scenarios...", "info");

        try {
          // Try to load demo data
          const response = await fetch("/json/demos.json");
          if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
          }

          const demoData = await response.json();

          test("Demo JSON loads successfully", () => true);

          test("Demo data has demos array", () => {
            return Array.isArray(demoData.demos);
          });

          test("Event-driven scenario exists", () => {
            return demoData.demos.some((demo) => demo.id === "event_driven");
          });

          test("Presence scenario exists", () => {
            return demoData.demos.some((demo) => demo.id === "presence");
          });

          test("Pubsub scenario exists", () => {
            return demoData.demos.some((demo) => demo.id === "pubsub");
          });

          // Test behavior types
          test("Agent types defined", () => {
            return (
              demoData.agentTypes && Object.keys(demoData.agentTypes).length > 0
            );
          });

          test("Behavior types defined", () => {
            return (
              demoData.behaviorTypes &&
              Object.keys(demoData.behaviorTypes).length > 0
            );
          });

          // Test new behavior types
          const newBehaviorTypes = [
            "messageForwarding",
            "autoResponse",
            "messageAggregation",
            "loadBalancing",
          ];
          newBehaviorTypes.forEach((behaviorType) => {
            test(`${behaviorType} behavior type exists`, () => {
              return demoData.behaviorTypes[behaviorType] !== undefined;
            });
          });

          // Test event-driven demo specifically
          const eventDrivenDemo = demoData.demos.find(
            (demo) => demo.id === "event_driven"
          );
          if (eventDrivenDemo) {
            test("Event-driven demo has nodes", () => {
              return eventDrivenDemo.nodes && eventDrivenDemo.nodes.length > 0;
            });

            test("Event-driven demo has behaviors", () => {
              return (
                eventDrivenDemo.behaviors &&
                eventDrivenDemo.behaviors.length > 0
              );
            });

            test("Event-driven demo has Python code", () => {
              return (
                eventDrivenDemo.pythonCode && eventDrivenDemo.pythonCode.code
              );
            });

            // Test specific behaviors in event-driven demo
            const behaviorTypes = eventDrivenDemo.behaviors.map((b) => b.type);
            newBehaviorTypes.forEach((behaviorType) => {
              test(`Event-driven demo includes ${behaviorType}`, () => {
                return behaviorTypes.includes(behaviorType);
              });
            });
          }
        } catch (error) {
          test("Demo JSON loading", () => `Failed to load: ${error.message}`);
        }
      }

      function startMiniDemo() {
        const scenario = document.getElementById("mini-scenario").value;
        log(`🎬 Starting mini demo with scenario: ${scenario}`, "info");

        try {
          // Initialize AgentDemo if not already done
          if (!AgentDemo.network) {
            // Set container to mini demo
            AgentDemo.container = document.getElementById("mini-demo");
            AgentDemo.init();
          }

          // Setup the selected scenario
          AgentDemo.scenario = scenario;
          AgentDemo.setupScenario(scenario);
          AgentDemo.start();

          log(`✅ Mini demo started successfully`, "success");
        } catch (error) {
          log(`❌ Mini demo failed to start: ${error.message}`, "error");
        }
      }

      function pauseMiniDemo() {
        try {
          AgentDemo.pause();
          log(`⏸️ Mini demo paused`, "info");
        } catch (error) {
          log(`❌ Failed to pause mini demo: ${error.message}`, "error");
        }
      }

      function resetMiniDemo() {
        try {
          AgentDemo.reset();
          log(`🔄 Mini demo reset`, "info");
        } catch (error) {
          log(`❌ Failed to reset mini demo: ${error.message}`, "error");
        }
      }

      // Initialize when page loads
      document.addEventListener("DOMContentLoaded", function () {
        log("🔍 SPADE Demo Verification Tool Loaded", "info");
        log('Click "Run All Tests" to verify enhanced functionality.', "info");
      });
    </script>
  </body>
</html>
